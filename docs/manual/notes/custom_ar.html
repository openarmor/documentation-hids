<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creating Customized Active Responses &#8212; OpenArmor</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-3.2.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/parallax.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../../../_static/js/jquery-fix.js"></script>
    <script src="../../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138780766-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-138780766-1');
</script>

<script type="text/javascript">
  var _ss = _ss || [];
  _ss.push(['_setDomain', 'https://koi-3QNN51VTHS.marketingautomation.services/net']);
  _ss.push(['_setAccount', 'KOI-4APYNOYP8O']);
  _ss.push(['_trackPageView']);
  window._pa = window._pa || {};
  // _pa.orderId = "myOrderId"; // OPTIONAL: attach unique conversion identifier to conversions
  // _pa.revenue = "19.99"; // OPTIONAL: attach dynamic purchase values to conversions
  // _pa.productId = "myProductId"; // OPTIONAL: Include product ID for use with dynamic ads
  (function() {
  var ss = document.createElement('script');
  ss.type = 'text/javascript'; ss.async = true;
  ss.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'koi-3QNN51VTHS.marketingautomation.services/client/ss.js?ver=2.4.0';
  var scr = document.getElementsByTagName('script')[0];
  scr.parentNode.insertBefore(ss, scr);
  })();
  </script>



  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default ">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><img src="../../../_static/OpenArmor_logo_bare_small.jpg">
          OpenArmor</a>
        <span class="navbar-text navbar-version pull-left"><b>3.6.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://theopenarmor.org/about/">About</a></li>
                <li><a href="https://theopenarmor.org/docs/">Documentation</a></li>
                <li><a href="https://theopenarmor.org/register-for-OpenArmor/">Get OpenArmor+</a></li>
                <li><a href="https://theopenarmor.org/downloads/">Downloads</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Manual</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbooks/index.html">User submitted Cookbooks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../development/build/index.html">Build, compile, and not much more</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/oRFC/index.html">oRFC:</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../syntax/index.html">Syntax and Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../formats/index.html">Output Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programs/index.html">Man pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="creating-customized-active-responses">
<h1>Creating Customized Active Responses<a class="headerlink" href="#creating-customized-active-responses" title="Permalink to this headline">¶</a></h1>
<p><em>by `Daniel Cid &lt;http://www.dcid.me/&gt;`_</em></p>
<p>OpenArmor by default comes with a few active response scripts, but if you ever need to expand them, this
tutorial can be of help.</p>
<p>As always, learning via examples is easier and faster. We will write a simple active response script to
e-mail the alert to a specific address.</p>
<div class="section" id="creating-the-command">
<h2>Creating the command:<a class="headerlink" href="#creating-the-command" title="Permalink to this headline">¶</a></h2>
<p>The first thing we need to do is to create a new “command” entry in the OpenArmor config.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&lt;command&gt;</span>
<span class="go">  &lt;name&gt;mail-test&lt;/name&gt;</span>
<span class="go">  &lt;executable&gt;mail-test.sh&lt;/executable&gt;</span>
<span class="go">  &lt;timeout_allowed&gt;no&lt;/timeout_allowed&gt;</span>
<span class="go">  &lt;expect /&gt;</span>
<span class="go">&lt;/command&gt;</span>
</pre></div>
</div>
<p>Since our script does not need a timeout, we set it to no. We also don’t expect any input (like srcip or
username), so we leave the “expect” tag empty. In the executable tag, we specify the name of the script
to be executed (it must be inside <code class="docutils literal notranslate"><span class="pre">/var/OpenArmor/active-response/bin/</span></code> ).</p>
<p><em>If you do need a srcip or username, just add it, eg: ``&lt;expect&gt;srcip&lt;/expect&gt;``</em></p>
<p>===2- Configure the Active response===</p>
<p>Next, we need to configure OpenArmor to run the active response. In my case, I want to run it on the OpenArmor server
(so I choose location server) and every time the rule 1002 is fired (see rules_id 1002). You can also specify
the level or different locations.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&lt;active-response&gt;</span>
<span class="go">   &lt;command&gt;mail-test&lt;/command&gt;</span>
<span class="go">   &lt;location&gt;server&lt;/location&gt;</span>
<span class="go">   &lt;rules_id&gt;1002&lt;/rules_id&gt;</span>
<span class="go">&lt;/active-response&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="create-active-response-script">
<h2>Create active response script:<a class="headerlink" href="#create-active-response-script" title="Permalink to this headline">¶</a></h2>
<p>With that done, we can create the active response script. The <code class="docutils literal notranslate"><span class="pre">mail-test.sh</span></code> must be inside the
<code class="docutils literal notranslate"><span class="pre">/var/OpenArmor/active-response/bin/</span></code> with the execution permissions set.</p>
<p><strong>What are the arguments passed to the script?</strong></p>
<ul class="simple">
<li><p>action (delete or add)</p></li>
<li><p>user name (or - if not set)</p></li>
<li><p>src ip (or - if not set)</p></li>
<li><p>Alert id (uniq for every alert)</p></li>
<li><p>Rule id</p></li>
<li><p>Agent name/host/filename</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>!/bin/sh
<span class="gp"># </span>E-mails an alert - copy at /var/OpenArmor/active-response/bin/mail-test.sh
<span class="gp"># </span>Change e-mail ADDRESSS
<span class="gp"># </span>Author: Daniel Cid

<span class="go">MAILADDRESS=&quot;xx@OpenArmor.net&quot;</span>
<span class="go">ACTION=$1</span>
<span class="go">USER=$2</span>
<span class="go">IP=$3</span>
<span class="go">ALERTID=$4</span>
<span class="go">RULEID=$5</span>

<span class="go">LOCAL=`dirname $0`;</span>
<span class="go">cd $LOCAL</span>
<span class="go">cd ../</span>
<span class="go">PWD=`pwd`</span>


<span class="gp"># </span>Logging the call
<span class="go">echo &quot;`date` $0 $1 $2 $3 $4 $5 $6 $7 $8&quot; &gt;&gt; ${PWD}/../logs/active-responses.log</span>


<span class="gp"># </span>Getting alert <span class="nb">time</span>
<span class="go">ALERTTIME=`echo &quot;$ALERTID&quot; | cut -d  &quot;.&quot; -f 1`</span>

<span class="gp"># </span>Getting end of alert
<span class="go">ALERTLAST=`echo &quot;$ALERTID&quot; | cut -d  &quot;.&quot; -f 2`</span>

<span class="gp"># </span>Getting full alert
<span class="go">grep -A 10 &quot;$ALERTTIME&quot; ${PWD}/../logs/alerts/alerts.log | grep -v &quot;.$ALERTLAST: &quot; -A 10 | mail $MAILADDRESS -s &quot;OpenArmor Alert&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="restart-OpenArmor-and-test-it">
<h2>Restart OpenArmor and test it:<a class="headerlink" href="#restart-OpenArmor-and-test-it" title="Permalink to this headline">¶</a></h2>
<p>After the configuration is done, you can restart OpenArmor and test the configuration. For the above example,
I can run the logger command to simular a segmentation fault message.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>/var/OpenArmor/bin/OpenArmor-control restart
<span class="gp"># </span>logger <span class="s2">&quot;Segmentation Fault&quot;</span>
</pre></div>
</div>
<p>You should get in the /var/OpenArmor/logs/active-response.log, the following:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Fri Jul 27 23:48:31 BRT 2007 /var/OpenArmor/active-response/bin/mail-test.sh add - - 1185590911.25916 1002 /var/log/messages</span>
</pre></div>
</div>
<p>And in your e-mail:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">from: root &lt;root@xx.org&gt;</span>
<span class="go">to: xx@OpenArmor.net</span>
<span class="go">date: Jul 27, 2007 11:48 PM</span>
<span class="go">subject: OpenArmor Alert</span>

<span class="go">** Alert 1185590911.25661: mail  - syslog,errors,</span>
<span class="go">2007 Jul 27 23:48:31 xx-&gt;/var/log/messages</span>
<span class="go">Rule: 1002 (level 7) -&gt; &#39;Unknown problem somewhere in the system.&#39;</span>
<span class="go">Src IP: (none)</span>
<span class="go">User: (none)</span>
<span class="go">Jul 27 23:48:30 xx dcid: Segmentation Fault 123</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2010-2021, OpenArmor Project Team.<br/>
    OpenArmor <b>OpenArmor.net</b> domain owned and maintained by <a href="https://theopenarmor.org" target="_blank">OpenArmor Foundation</a><br/>
    Home page graphics courtesy of <a href="https://pixabay.com" target="_blank">pixabay</a>
    </p>
  </div>
</footer>
  </body>
</html>