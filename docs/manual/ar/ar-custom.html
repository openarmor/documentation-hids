<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Creating Customized Active Responses &#8212; OpenArmor</title>
    <link
      rel="stylesheet"
      href="../../../_static/pygments.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="../../../_static/bootstrap-sphinx.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="../../../_static/bootstrap-3.2.0/css/bootstrap.min.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="../../../_static/bootstrap-3.2.0/css/bootstrap-theme.min.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="../../../_static/bootstrap-sphinx.css"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="../../../_static/parallax.css"
      type="text/css"
    />
    <script
      id="documentation_options"
      data-url_root="../../../"
      src="../../../_static/documentation_options.js"
    ></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script src="../../../_static/js/jquery-fix.js"></script>
    <script src="../../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script src="../../../_static/bootstrap-sphinx.js"></script>
    <link
      rel="author"
      title="About these documents"
      href="../../../about.html"
    />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link
      rel="next"
      title="UNIX: Active Response Configuration"
      href="ar-unix.html"
    />
    <link rel="prev" title="Active Response" href="index.html" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=UA-138780766-1"
    ></script>

    <link rel="icon" href="favicon/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <div id="navbar" class="navbar navbar-inverse navbar-default">
      <div class="container">
        <div class="navbar-header">
          <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
          <button
            type="button"
            class="navbar-toggle"
            data-toggle="collapse"
            data-target=".nav-collapse"
          >
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../index.html"
            ><img src="../../../_static/OpenArmor_logo_bare_small.jpg" />
            OpenArmor</a
          >
          <span class="navbar-text navbar-version pull-left"><b>3.6.0</b></span>
        </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li><a href="https://theopenarmor.org/about/">About</a></li>
            <li><a href="https://theopenarmor.org/docs/">Documentation</a></li>
            <li>
              <a href="https://theopenarmor.org/register-for-OpenArmor/"
                >Get OpenArmor+</a
              >
            </li>
            <li><a href="https://theopenarmor.org/downloads/">Downloads</a></li>

            <li class="dropdown globaltoc-container">
              <a
                role="button"
                id="dLabelGlobalToc"
                data-toggle="dropdown"
                data-target="#"
                href="../../../index.html"
                >Site <b class="caret"></b
              ></a>
              <ul
                class="dropdown-menu globaltoc"
                role="menu"
                aria-labelledby="dLabelGlobalToc"
              >
                <ul class="current">
                  <li class="toctree-l1 current">
                    <a class="reference internal" href="../index.html"
                      >Manual</a
                    >
                  </li>
                </ul>
                <ul>
                  <li class="toctree-l1">
                    <a class="reference internal" href="../../faq/index.html"
                      >Frequently asked questions</a
                    >
                  </li>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../cookbooks/index.html"
                      >User submitted Cookbooks</a
                    >
                  </li>
                </ul>
                <ul>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../development/build/index.html"
                      >Build, compile, and not much more</a
                    >
                  </li>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../development/oRFC/index.html"
                      >oRFC:</a
                    >
                  </li>
                </ul>
                <ul>
                  <li class="toctree-l1">
                    <a class="reference internal" href="../../syntax/index.html"
                      >Syntax and Options</a
                    >
                  </li>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../formats/index.html"
                      >Output Formats</a
                    >
                  </li>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../programs/index.html"
                      >Man pages</a
                    >
                  </li>
                  <li class="toctree-l1">
                    <a
                      class="reference internal"
                      href="../../examples/index.html"
                      >Examples</a
                    >
                  </li>
                </ul>
              </ul>
            </li>

            <li>
              <a href="index.html" title="Previous Chapter: Active Response"
                ><span
                  class="glyphicon glyphicon-chevron-left visible-sm"
                ></span
                ><span class="hidden-sm hidden-tablet"
                  >&laquo; Active Response</span
                >
              </a>
            </li>
            <li>
              <a
                href="ar-unix.html"
                title="Next Chapter: UNIX: Active Response Configuration"
                ><span
                  class="glyphicon glyphicon-chevron-right visible-sm"
                ></span
                ><span class="hidden-sm hidden-tablet"
                  >UNIX: Active ... &raquo;</span
                >
              </a>
            </li>
          </ul>

          <form
            class="navbar-form navbar-right"
            action="../../../search.html"
            method="get"
          >
            <div class="form-group">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="Search"
              />
            </div>
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="section" id="creating-customized-active-responses">
            <span id="manual-ar-custom"></span>
            <h1>
              Creating Customized Active Responses<a
                class="headerlink"
                href="#creating-customized-active-responses"
                title="Permalink to this headline"
                >¶</a
              >
            </h1>
            <p>
              OpenArmor by default comes with a few active response scripts, but
              if you ever need to expand them, this tutorial can be of help.
            </p>
            <p>
              As always, learning via examples is easier and faster. We will
              write a simple active response script to e-mail the alert to a
              specific address.
            </p>
            <div class="section" id="creating-the-command">
              <h2>
                Creating the command<a
                  class="headerlink"
                  href="#creating-the-command"
                  title="Permalink to this headline"
                  >¶</a
                >
              </h2>
              <p>
                The first thing we need to do is to create a new “command” entry
                in the OpenArmor config.
              </p>
              <div class="highlight-xml notranslate">
                <div class="highlight">
                  <pre><span></span><span class="nt">&lt;command&gt;</span>
    <span class="nt">&lt;name&gt;</span>mail-test<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;executable&gt;</span>mail-test.sh<span class="nt">&lt;/executable&gt;</span>
    <span class="nt">&lt;timeout_allowed&gt;</span>no<span class="nt">&lt;/timeout_allowed&gt;</span>
    <span class="nt">&lt;expect</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/command&gt;</span>
</pre>
                </div>
              </div>
              <p>
                Since our script does not need a timeout, we set it to no. We
                also don’t expect any input (like srcip or username), so we
                leave the “expect” tag empty. In the executable tag, we specify
                the name of the script to be executed (it must be inside
                /var/OpenArmor/active-response/bin/ ).
              </p>
              <div class="admonition note">
                <p class="admonition-title">Note</p>
                <p>
                  If you do need a srcip or username, just add it, eg:
                  &lt;expect&gt;srcip&lt;/expect&gt;
                </p>
              </div>
            </div>
            <div class="section" id="configure-the-active-response">
              <h2>
                Configure the Active response<a
                  class="headerlink"
                  href="#configure-the-active-response"
                  title="Permalink to this headline"
                  >¶</a
                >
              </h2>
              <p>
                Next, we need to configure OpenArmor to run the active response.
                In my case, I want to run it on the OpenArmor server (so I
                choose location server) and every time the rule 1002 is fired
                (see rules_id 1002). You can also specify the level or different
                locations.
              </p>
              <div class="highlight-xml notranslate">
                <div class="highlight">
                  <pre><span></span><span class="nt">&lt;active-response&gt;</span>
    <span class="nt">&lt;command&gt;</span>mail-test<span class="nt">&lt;/command&gt;</span>
    <span class="nt">&lt;location&gt;</span>server<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;rules_id&gt;</span>1002<span class="nt">&lt;/rules_id&gt;</span>
<span class="nt">&lt;/active-response&gt;</span>
</pre>
                </div>
              </div>
            </div>
            <div class="section" id="create-active-response-script">
              <h2>
                Create active response script<a
                  class="headerlink"
                  href="#create-active-response-script"
                  title="Permalink to this headline"
                  >¶</a
                >
              </h2>
              <p>
                With that done, we can create the active response script. The
                mail-test.sh must be inside the
                /var/OpenArmor/active-response/bin/ with the execution
                permissions set.
              </p>
              <p>What are the arguments are passed to the script?</p>
              <ol class="arabic simple">
                <li><p>action (delete or add)</p></li>
                <li><p>user name (or - if not set)</p></li>
                <li><p>src ip (or - if not set)</p></li>
                <li><p>Alert id (uniq for every alert)</p></li>
                <li><p>Rule id</p></li>
                <li><p>Agent name/host</p></li>
                <li><p>Filename</p></li>
              </ol>
              <div class="highlight-sh notranslate">
                <div class="highlight">
                  <pre><span></span><span class="ch">#!/bin/sh</span>
<span class="c1"># E-mails an alert - copy at /var/OpenArmor/active-response/bin/mail-test.sh</span>
<span class="c1"># Change e-mail ADDRESSS</span>
<span class="c1"># Author: Daniel Cid</span>

<span class="nv">MAILADDRESS</span><span class="o">=</span><span class="s2">&quot;xx@OpenArmor.net&quot;</span>
<span class="nv">ACTION</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">USER</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">IP</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">ALERTID</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">RULEID</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">LOCAL</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span><span class="p">;</span>
<span class="nb">cd</span> <span class="nv">$LOCAL</span>
<span class="nb">cd</span> ../
<span class="nv">PWD</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>


<span class="c1"># Logging the call</span>
<span class="nb">echo</span> <span class="s2">&quot;`date` </span><span class="nv">$0</span><span class="s2"> </span><span class="nv">$1</span><span class="s2"> </span><span class="nv">$2</span><span class="s2"> </span><span class="nv">$3</span><span class="s2"> </span><span class="nv">$4</span><span class="s2"> </span><span class="nv">$5</span><span class="s2"> </span><span class="nv">$6</span><span class="s2"> </span><span class="nv">$7</span><span class="s2"> </span><span class="nv">$8</span><span class="s2">&quot;</span> &gt;&gt; <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../logs/active-responses.log


<span class="c1"># Getting alert time</span>
<span class="nv">ALERTTIME</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$ALERTID</span><span class="s2">&quot;</span> <span class="p">|</span> cut -d  <span class="s2">&quot;.&quot;</span> -f <span class="m">1</span><span class="sb">`</span>

<span class="c1"># Getting end of alert</span>
<span class="nv">ALERTLAST</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$ALERTID</span><span class="s2">&quot;</span> <span class="p">|</span> cut -d  <span class="s2">&quot;.&quot;</span> -f <span class="m">2</span><span class="sb">`</span>

<span class="c1"># Getting full alert</span>
grep -A <span class="m">10</span> <span class="s2">&quot;</span><span class="nv">$ALERTTIME</span><span class="s2">&quot;</span> <span class="si">${</span><span class="nv">PWD</span><span class="si">}</span>/../logs/alerts/alerts.log <span class="p">|</span> grep -v <span class="s2">&quot;.</span><span class="nv">$ALERTLAST</span><span class="s2">: &quot;</span> -A <span class="m">10</span> <span class="p">|</span> mail <span class="nv">$MAILADDRESS</span> -s <span class="s2">&quot;OpenArmor Alert&quot;</span>
</pre>
                </div>
              </div>
            </div>
            <div class="section" id="restart-OpenArmor-and-test">
              <h2>
                Restart OpenArmor and test<a
                  class="headerlink"
                  href="#restart-OpenArmor-and-test"
                  title="Permalink to this headline"
                  >¶</a
                >
              </h2>
              <p>
                After the configuration is done, you can restart OpenArmor and
                test the configuration. For thee above example, I can run the
                logger command to similar a segmentation fault message.
              </p>
              <div class="highlight-console notranslate">
                <div class="highlight">
                  <pre><span></span><span class="gp"># </span>/var/OpenArmor/bin/OpenArmor-control restart
<span class="gp"># </span>logger <span class="s2">&quot;Segmentation Fault&quot;</span>
</pre>
                </div>
              </div>
              <p>
                You should get in the /var/OpenArmor/logs/active-response.log,
                the following:
              </p>
              <div class="highlight-console notranslate">
                <div class="highlight">
                  <pre><span></span><span class="go">Fri Jul 27 23:48:31 BRT 2007 /var/OpenArmor/active-response/bin/mail-test.sh add - - 1185590911.25916 1002 /var/log/messages</span>
</pre>
                </div>
              </div>
              <p>And in your e-mail:</p>
              <div class="highlight-default notranslate">
                <div class="highlight">
                  <pre><span></span><span class="n">from</span><span class="p">:</span> <span class="n">root</span> <span class="o">&lt;</span><span class="n">root</span><span class="nd">@xx</span><span class="o">.</span><span class="n">org</span><span class="o">&gt;</span>
<span class="n">to</span><span class="p">:</span> <span class="n">xx</span><span class="nd">@OpenArmor</span><span class="o">.</span><span class="n">net</span>
<span class="n">date</span><span class="p">:</span> <span class="n">Jul</span> <span class="mi">27</span><span class="p">,</span><span class="mi">27</span> <span class="mi">2007</span> <span class="mi">11</span><span class="p">:</span><span class="mi">48</span> <span class="n">PM</span>
<span class="n">subject</span><span class="p">:</span> <span class="n">OpenArmor</span> <span class="n">Alert</span>

<span class="o">**</span> <span class="n">Alert</span> <span class="mf">1185590911.25661</span><span class="p">:</span> <span class="n">mailsl</span>  <span class="o">-</span> <span class="n">syslog</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span>
<span class="mi">2007</span> <span class="n">Jul</span> <span class="mi">27</span> <span class="mi">23</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">31</span> <span class="n">xx</span><span class="o">-&gt;/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">messages</span>
<span class="n">Rule</span><span class="p">:</span> <span class="mi">1002</span> <span class="p">(</span><span class="n">level</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Unknown problem somewhere in the system.&#39;</span>
<span class="n">Src</span> <span class="n">IP</span><span class="p">:</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span>
<span class="n">User</span><span class="p">:</span> <span class="p">(</span><span class="n">none</span><span class="p">)</span>
<span class="n">Jul</span> <span class="mi">27</span> <span class="mi">23</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">30</span> <span class="n">xx</span> <span class="n">dcid</span><span class="p">:</span> <span class="n">Segmentation</span> <span class="n">Fault</span> <span class="mi">123</span>
</pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="pull-right">
          <a href="#">Back to top</a>
        </p>
        <p>
          &copy; Copyright 2010-2021, OpenArmor Project Team.<br />
          OpenArmor <b>OpenArmor.net</b> domain owned and maintained by
          <a href="https://theopenarmor.org" target="_blank"
            >OpenArmor Foundation</a
          ><br />
          Home page graphics courtesy of
          <a href="https://pixabay.com" target="_blank">pixabay</a>
        </p>
      </div>
    </footer>
  </body>
</html>
